From 4689694f47444525ee86e828c655d49105c028a5 Mon Sep 17 00:00:00 2001
From: kkky <kkkykin@foxmail.com>
Date: Fri, 9 Jan 2026 21:00:44 +0800
Subject: [PATCH] openai reverse proxy image video

---
 src/endpoints/openai.js | 25 ++++++++++++++++++-------
 1 file changed, 18 insertions(+), 7 deletions(-)

diff --git a/src/endpoints/openai.js b/src/endpoints/openai.js
index c4b54a7..157b7e5 100644
--- a/src/endpoints/openai.js
+++ b/src/endpoints/openai.js
@@ -488,7 +488,10 @@ router.post('/chutes/models/embedding', async (request, response) => {
 
 router.post('/generate-image', async (request, response) => {
     try {
-        const key = readSecret(request.user.directories, SECRET_KEYS.OPENAI);
+        const { reverse_proxy: reverseProxy, proxy_password: proxyPassword, ...requestBody } = request.body ?? {};
+        const useReverseProxy = Boolean(reverseProxy);
+        const baseUrl = useReverseProxy ? reverseProxy : 'https://api.openai.com/v1';
+        const key = useReverseProxy ? (proxyPassword || readSecret(request.user.directories, SECRET_KEYS.OPENAI)) : readSecret(request.user.directories, SECRET_KEYS.OPENAI);
 
         if (!key) {
             console.warn('No OpenAI key found');
@@ -496,14 +499,18 @@ router.post('/generate-image', async (request, response) => {
         }
 
         console.debug('OpenAI request', request.body);
+        const apiUrl = `${baseUrl}/images/generations`;
+
+        const headers = {};
+        setAdditionalHeaders(request, { headers }, apiUrl);
 
-        const result = await fetch('https://api.openai.com/v1/images/generations', {
+        const result = await fetch(apiUrl, {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
                 Authorization: `Bearer ${key}`,
             },
-            body: JSON.stringify(request.body),
+            body: JSON.stringify(requestBody),
         });
 
         if (!result.ok) {
@@ -528,7 +535,9 @@ router.post('/generate-video', async (request, response) => {
             controller.abort();
         });
 
-        const key = readSecret(request.user.directories, SECRET_KEYS.OPENAI);
+        const useReverseProxy = Boolean(request.body?.reverse_proxy);
+        const baseUrl = useReverseProxy ? request.body.reverse_proxy : 'https://api.openai.com/v1';
+        const key = useReverseProxy ? (request.body?.proxy_password || readSecret(request.user.directories, SECRET_KEYS.OPENAI)) : readSecret(request.user.directories, SECRET_KEYS.OPENAI);
 
         if (!key) {
             console.warn('No OpenAI key found');
@@ -536,8 +545,10 @@ router.post('/generate-video', async (request, response) => {
         }
 
         console.debug('OpenAI video generation request', request.body);
+        const headers = {};
+        setAdditionalHeaders(request, { headers }, baseUrl);
 
-        const videoJobResponse = await fetch('https://api.openai.com/v1/videos', {
+        const videoJobResponse = await fetch(`${baseUrl}/videos`, {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
@@ -575,7 +586,7 @@ router.post('/generate-video', async (request, response) => {
             await delay(5000 + attempt * 1000);
             console.debug(`Polling OpenAI video job ${videoJob.id}, attempt ${attempt + 1}`);
 
-            const pollResponse = await fetch(`https://api.openai.com/v1/videos/${videoJob.id}`, {
+            const pollResponse = await fetch(`${baseUrl}/videos/${videoJob.id}`, {
                 method: 'GET',
                 headers: {
                     'Authorization': `Bearer ${key}`,
@@ -598,7 +609,7 @@ router.post('/generate-video', async (request, response) => {
             }
 
             if (pollResult.status === 'completed') {
-                const contentResponse = await fetch(`https://api.openai.com/v1/videos/${videoJob.id}/content`, {
+                const contentResponse = await fetch(`${baseUrl}/videos/${videoJob.id}/content`, {
                     method: 'GET',
                     headers: {
                         'Authorization': `Bearer ${key}`,
-- 
2.51.2

